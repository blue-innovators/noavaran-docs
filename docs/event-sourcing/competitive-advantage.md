# مزیت رقابتی Event Sourcing

<p style="text-align:justify;">
شما میتوانید توانایی آنالیز تاریخچه کامل دیتا را به وسیله ذخیره سازی هر رویداد با اهمیت با ترتیب زمانی و timestamp بدست بیاورید.
همچنین میتوانید با بازپخش رویدادها به وضعیت فعلی برسید.
حتی میتوانید هر زیر رشته از رویدادها ها را برای رسیدن به یک وضعیت خاص و شناسایی فعالیت هایی که باعث ایجاد آن وضعیت شده اند بازپخش کنید.
این کار با نام Temporal Query یا کوئری زمانی شناخته می شود، یک قابلیت متحول کننده که جزو قابلیت های ذاتی Event Sourcing می باشد.
</p>

## 🔸 Temporal Queries (کوئری های زمانی)

<p style="text-align:justify;">
کوئری های زمانی به مانند توانایی سفر به زمان‌های گذشته می باشند. زیرا که به واسه اجرای این کوئری ها شما نمیتوانید به وضعیت سیستم در هر نقطه زمانی دلخواه در گذشته برگردید.
</p>

<p style="text-align:justify;">
حال به مثال دپارتمان پشتیبانی مشتریان برمیگردیم. این بار فرض میکنیم دیتای تاریخچه حساب مشتری نیز  با مکانیز Event Sourcing ذخیره شده است.
اپراتور پشتیبانی اکنون میتواند در نقطه های مختلف زمانی در گذشته اطلاعات را چک نماید تا بتواند بفهمد در کدام نقطه از زمان مبلغ کسر شده از حساب کاربر نادرست بوده است.
شکل زیر نشان میدهد که چطور کوئری زمانی میتواند به یک رشته از رویدادها که نمایانگر جزئیات فعالیت های حساب کاربری مشتری می باشد اعمال شوند.
</p>

<p align="center">
  <img src="/assets/images/event-sourcing-figure-22-1.png"/>
</p>

<p style="text-align:justify;">
بازپخش رویدادها یک مکانیزم درونی کوئری های زمانی می باشد. در شکل بالا از بازپخش رویدادها برای محاسبه وضعیت در دو نقطه متفاوت زمانی استفاده شده است. 
شما به عنوان یک برنامه نویس در طی دوران کاری خود حتماً به این کوئری ها برخورد کرده اید. ابزار سورس کنترل Git خود نمونه بارزی از این موضوع می باشد.
در ادامه شما میتوانید مثال های واقعی از اجرا کردن یک کوئری زمانی در یک Event Store واقعی ببینید.
</p>

<p style="text-align:justify;">
با بهره گیری از رشته رویدادهای شکل بالا اپراتور پشتیبانی تلفن همراه میتواند سوال‌های در مورد تاریخچه فعالیت مشتری بپرسد. و حتی جالب تر از آن یک اپراتور میتواند داده چندین حساب مشتری را با هم ترکیب کند تا رفتارهای یک دموگرافیک خاص از مشتریان را شناسایی کند. این اطلاعات میتواند به منظور اجرای بازاریابی کمی و تصمیمات توسعه محصول استفاده شوند. Projection ها فیچری زیرساختی هستند که به ما اجازه میدهند چندین رشته از رویداد را با هم ترکیب کرده و کوئری های زمانی پیچیده بر روی آن ها اعمال نماییم.
</p>


## 🔸 Projections

<p style="text-align:justify;">
محدودیت برخی Event store ها دشواری در اجرای کوئری های فی البداهه در چندین رشته از رویدادها می باشد.
در یک دیتابیس sql این موضوع با join های مستقیم قابل حل می باشد. برای حل این مشکل Event Store ها از کانسپتی با نام Projection استفاده می کنند.
این Projection ها چندین رشته رویداد ورودی را به یک رشته رویداد خروجی تبدیل می نمایند.
به عنوان مثال یک اپراتور تلفن همراه میتواند رشته رویدادهای مربوط به حساب بسیاری از مشتریانش را ترکیب کند تا بتواند به این سوال پاسخ دهند :
"تعداد کل دقایق مکالمه های برقرار شده در یک روز خاص توسط یک دموگرافیک خاص در طی یک رویداد ورزشی مشخص چقدر بوده است ؟"
یا این سوال :
"آیا میران جمع دقایق مکالمه یک دموگرافیک خاص در طی یک آفر ویژه افزایش یافت ؟"
شکل زیر نشان می دهد که چطور چنین سوالات دلبخواهی میتوانند به واسطه ترکیب رشته رویدادهای مختلف با استفاده از Projection پرسیده شوند :
</p>

<p align="center">
  <img src="/assets/images/event-sourcing-figure-22-2.png"/>
</p>

<p style="text-align:justify;">
در شکل بالا هر رشته رویداد نمانده حساب یک مشتری است که به عنوان ورودی به متد Projection داده شده است.
Proejction نمایش داده شده در شکل بالا تمامی رویدادهای بین تاریخ یکم الی پنجم مارس که صاحب آن بین 16 الی 24 سال سن دارد را منتشر خواهد کرد.
با داشتن تمامی رویدادهای مورد نظر در یک رشته تکی اجرای کوئری به منظور بدست آوردن جمع کل، میانگین و یا دیگر اطلاعات مورد نیاز آسان تر و بهینه تر می باشد.
</p>

<p style="text-align:justify;">
این امان نیز وجود دارد که شما بخواهید چندین رشته رویداد را به یک یا چندین رشته رویداد دیگر تبدیل نمایید. در ادامه خواهید دید که با Event Store ساخته شده توسط Greg young شما قدرت و انعطاف بالایی خواهید داشت. شما میتوانید از قابلیت های غنی جاوا اسکریپت در متدهای Proejction استفاده نمایید.
</p>

## 🔸 Snapshots

<p style="text-align:justify;">
یکی از عواقب نگهداری وضعیت سیستم به عنوان مجموعه ای از رویدادها این است که رشته های رویدادها می توانند خیلی بزرگ شوند بدین معنا که زمان بازپخش این رویدادها میتواند بصورت قابل توجهی قابل توجهی افزایش پیدا کند. برای جلوگیری از این مشکل پرفورمنس event store ها از snapshot استفاده میکنند.
snapshot ها قدم های میانی در یک رشته رویداد هستن که نمایانگر وضعیت آخر بعد از بازپخش های رویدادهای گذشته آن می باشند. مثال زیر را مشاهده نمایید :
</p>

<p align="center">
  <img src="/assets/images/event-sourcing-figure-22-3.png"/>
</p>

<p style="text-align:justify;">
وقتی یک برنامه میخواهد وضعیت فعلی یک اگریگیت را از رشته رویدادهایش لود کند تنها کاری که بایستی انجام شود پیدا کردن آخرین Snapshot و بازپخش زیررشته ای از رویداد ها بعد از آن snapshot می باشد.
</p>