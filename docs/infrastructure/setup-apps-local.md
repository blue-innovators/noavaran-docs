# اجرای نرم‌افزارهای شرکت بصورت لوکال

در این قسمت به صورت قدم به قدم نرم افزارهای موجود در شرکت را بصورت لوکال بر روی یک کامپیوتر راه اندازی میکنیم. این امکان به توسعه دهندگان اجازه می‌دهد تا دیپندنسی خود به هر کدام از سرورها را جهت دریافت سرویس مد نظر حذف کنند.

## 🔸 پیش نیازها

برای راه اندازی نرم‌افزار‌های شرکت بصورت لوکال شما به یک سیستم که مشخصات زیر را داشته باشد نیاز دارید:

* بر روی آن داکر نصب شده باشد
* بر روی آن گیت نصب شده باشد
* ادیتور متنی داشته باشد
* به اینترنت دسترسی داشته باشد
* فضایی که داکر درآن نصب شده است حداقل 30 گیگ ظرفیت خالی داشته باشد
* رم سیستم حداقل 8 گیگ باشد

## 🔸راه اندازی برای بار اول

راه اندازی نرم افزارهای شرکت بصورت لوکال تفاوت‌هایی با دفعات بعدی دارد. اما علت این تفاوت چیست؟

* احراز هویت ریپازیتوری‌های داکر
* نصب کردن certificate مورد نیاز برای راه اندازی ssl لوکال
* ساخت network جهت ارتباط بین container ها
* ایجاد فایل .env
* ایجاد دیتابیس های نرم افزارها
* ایجاد کیف پول‌های مورد نیاز جهت پرداخت
* آپلود فایلها و عکس‌های مورد نیاز در سرور minio

این‌ها تمامی کارهایی هستند که در دفعات بعدی نیازی به انجام آن‌ها نمی‌باشد. در ادامه تمامی موارد را با هم بررسی میکنیم.

برای راه اندازی نرم افزارهای شرکت بصورت لوکال به ترتیب زیر عمل میکنیم : 

### 🔹 1. Clone کردن پروژه Docker Deploy

در ابتدا یک پوشه برای گرفتن سورس کد پروژه docker deploy ایجاد میکنیم. سپس از آدرس زیر پروژه را در پوشه ایجاد شده clone میکنیم:
```
http://tfs.bidev.ir/DefaultCollection/Deployment/_git/deploy-docker
```
نکته 1: درصورتی که به این ریپازیتوری دسترسی ندارید، به مدیر خود اطلاع دهید.  
نکته 2: فعلا تغییرات مربوط به اجرای تمام سیستم بصورت لوکال در برنچ اصلی ادغام نشده است، برای همین بعد از دریافت کدها به برنچ local-dev منتقل شوید.

### 🔹 2. نصب کردن فایل certificate

برای راه اندازی ارتباط ssl بصورت لوکال لازم است که certificate اصلی را بر روی سیستم عامل خود trust کنید.  
برای سیستم عامل ویندوز میتوانید فایل `certs/ca.pfx` را با دابل کلیک کردن و قرار دادن آن در قسمت Trusted root authorities به سیستم عامل trust کنید.  
برای سیستم عامل لینوکس میتوانید به شکل زیر عمل کنید:
```sh
$ cp ./certs/ca.crt /usr/local/share/ca-certificates/blueinnocators-ca.crt
$ chmod 644 /usr/local/share/ca-certificates/blueinnocators-ca.crt && update-ca-certificates
```

### 🔹 3. اضافه کردن دامین‌های مورد نیاز به فایل host

حال لازم است که در فایل host سیستم تمامی دامین‌های مورد نیاز را وارد کنیم تا بتوانیم آدرس های مورد نیازمان را بصورت لوکال در مرورگر سیستم خود ببینیم.
آدرس ها را به شکل زیر تماماً به IP لوکال مپ میکنیم:
```
127.0.0.1	static.local.dev
127.0.0.1	demo.local.dev
127.0.0.1	admin.local.dev
127.0.0.1	parsa.local.dev
127.0.0.1	auth.local.dev
127.0.0.1	payment.local.dev
127.0.0.1	credits.local.dev
127.0.0.1	market.local.dev
127.0.0.1	restora.local.dev
```

### 🔹 4. لاگین کردن روی ریپازیتوری‌های dcr و dreg داکر

 قدم بعدی لاگین کردن برای دسترسی داشتن به ریپازیتوری‌های داخلی داکر شرکت می‌باشد. بدین منظور در terminal سیستم خود دو دستور زیر را اجرا کنید :

```
docker login dcr.bidev.ir -u developer -p 123
docker login dreg.bidev.ir -u developer -p 123
```

### 🔹 5. ایجاد شبکه keepapp

حال بایستی شبکه ای با نام keepapp ایجاد کنیم زیرا که تمامی سرویس‌های ما بر روی این شبکه با یکدیگر در ارتباط خواهند بود. برای ایجاد این شبکه دستور زیر را در terminal اجرا نمایید:
```sh
docker network create keepapp
```

### 🔹 6. ساخت فایل .env

در سورس کد یک فایل .env.sample گذاشته شده است. آن را کپی کرده و نامش را به .env تغییر دهید.  
این فایل بصورت پیشفرض حاوی تنظیماتی برای راه اندازی سیستم در محیط توسعه لوکال است. ولی درصورت نیاز میتوانید تنظیمات آنرا به دلخواه خود تغییر دهید.

### 🔹 7. راه اندازی Infrastructure

خب حالا میخواهیم اولین سرویس‌های مورد نیازمان را راه اندازی کنیم. Infrastructure شامل تمامی سرویس های زیر ساختی میباشد که مورد استفاده نرم افزار داخلی شرکت می باشند. لیست سرویس به شرح زیر است:

* mssql
* rabittmq
* redis
* minio
* seq

برای اجرا این دستور ابتدا به مسیر root پروژه docker-deploy بروید و در آنجا terminal را باز کرده و دستور زیر را اجرا نمایید :

```sh
docker-compose -f .\docker-compose.database.yml up -d
docker-compose -f .\docker-compose.infrastructure.yml up -d
```

### 🔹 8. کمی صبر، اما چرا؟

زیرا بعد از راه اندازی سرویس‌های زیرساخت حدود 1 الی 2 دقیقه زمان مورد نیاز می باشد تا بصورت کامل اجرا شوند و بقیه نرم افزارها بتوانند به آنها متصل شوند. بنابراین بهتر است که یک الی دو دقیقه صبر نمایید.

### 🔹 9. این قسمت مربوط به راه اندازی اولیه mssql برای لینوکسی هاست - اگر ویندوزی هستید نخوانید 😁

چنانچه سیستم عامل شما لینوکس می باشد لازم است که دسترسی هایی را به یوزر mssql خود بدهید تا بتواند به volume های mssql دسترسی پیدا کند.
برای اینکار ابتدا لازم است که شناسه کاربر mssql را ابتدا بدست آوردید. برای اینکار میتوانید از دستور زیر استفاده نمایید :

```sh
docker run -it dreg.bidev.ir/mssql/server:2019-latest id mssql
# the result would be like:
# uid=10001(mssql) gid=0(root) groups=0(root)
```

سپس به این شناسه یوزر دسترسی volume های سرویس mssql را می دهیم. به این صورت :

```sh
sudo chown 10001 ./volumes/sqldata
sudo chmod 777 -R ./volumes/sqldata
```

### 🔹 10. اجرای اسکریپت‌های ساخت دیتابیس‌های مورد نیاز سرویس‌های زیرساخت

حال که mssql به صورت کامل راه اندازی شده است لازم است اسکریپت ساخت دیتابیس های سرویس های کامان را بر روی sql اجرا نماییم. این اسکریپت ها در پوشه migrations سورس کد گذاشته شده اند. برای اجرای این اسکریپت‌ها دستورات زیر را در powershell اجرا نمایید : 

```sh
docker exec sqldb bash -c '/migrations/_migrate.sh Common'
docker exec sqldb bash -c '/migrations/_migrate.sh Logging'
docker exec sqldb bash -c '/migrations/_migrate.sh Payment'
docker exec sqldb bash -c '/migrations/_migrate.sh Credits'
docker exec sqldb bash -c '/migrations/_migrate.sh Restora'
```
اگر فایلهای اسگریپت مایگریشن دیگری نیز داشتید که نیاز بود به یک دیتابیس اعمال شود ابتدا فایلها را به پوشه migrations اضافه کرده و سپس از دستور زیر برای اعمال مایگریشن به دیتابیس استفاده کنید:
```sh
docker exec sqldb sh -c '/opt/mssql-tools/bin/sqlcmd -S . -U sa -P $SA_PASSWORD -d <database-name> -i /migrations/<migrationfile.sql>'
```

### 🔹 11. تنظیمات اولیه و آپلود فایلهای مورد نیاز روی minio

حال بایستی یک سری تنظیمات را روی سرور minio انجام دهیم و عکس‌های اولیه را ایجاد نماییم. برای شروع آدرس زیر را در مرورگر خود باز نمایید: 

```
http://localhost:9001/login
```
سپس با مشخصات زیر وارد پنل شوید:

```
Username: minioadmin
Password: minioadmin
```
از منوی سمت چپ گزینه buckets را انتخاب کرده و گزینه create Bucket را بزنید. و یک Bucket با نام `public` ایجاد نمایید. بعد از آن روی گزینه Manage کلیک کنید. مطابق شکل زیر :

<p align="center">
  <img src="/assets/images/create-bucket.png" />
</p>

در قسمت Manage مقدار Access Policy این bucket را روی حالت public بگذارید. مطابق تصویر :

<p align="center">
  <img src="/assets/images/bucket-access-policy.png" />
</p>

بعد از آن محتوای پوشه minio-public که در سورس کد docker-deploy گذاشته شده را با همان ساختار پوشه در bucket پابلیک آپلود نمایید.

آخرین کار تنظیم service account سرور minio می باشد برای آنکه نرم افزارها با آن ارتباط برقرار نمایند. برای اینکار از منوی سمت چپ در قسمت Indentity گزینه Service Accounts را اتنخاب میکنید و گزینه Create Service Account را میزنید. مطابق تصویر زیر: 

<p align="center">
  <img src="/assets/images/service-account.png" />
</p>

برای این سرویس اکانت مقادیری که در فایل .env گذاشته شده اند را جایگذاری میکنیم : 

```
AccessKey: T3Niah1BrXCAVr2m
SecretKey: NRBkCpY26TAsHwXr4JfxNs6cGBaUj6D4
```

### 🔹 12. راه اندازی Gateway
اکنون Gateway را بایستی راه اندازی کنیم تا بتوانیم از آدرس های مورد نظرمان به سرویس ها دسترسی داشته باشیم. برای اینکار دستور زیر را اجرا میکنیم:
```sh
docker-compose -f .\docker-compose.gateway.yml up -d
```

### 🔹 13. راه اندازی Common
حال میخواهیم سرویس‌های common را راه اندازی کنیم. برای راه اندازی این سرویس ها به root پروژه docker deploy رفته و در آنجا terminal را باز میکنیم. و دستور زیر را در آن اجرا میکنیم :

```sh
docker-compose -f .\docker-compose.common.yml up -d
```

### 🔹 14. ایجاد دیتای مورد نیاز برای wallet ها با api call
خب در این قسمت شما نیاز دارید که حداقل دو عدد api call انجام دهید :

* ساخت ولت های شعبه کسب و کار تستی
* ساخت ولت یوزر ناشناس سیستم که برای خریدهای بدون لاگین استفاده می شود

برای این منظور لازم است که ابتدا یک توکن ساپورت جهت کار کردن با سیستم های common دریافت نمایید. به شکل زیر می توانید درخواست توکن بدهید: 

```
POST /api/credentials/ HTTP/1.1
Host: auth.local.dev
Content-Type: application/json
Content-Length: 99

{
    "username":"support",
    "password":"supPORT@123",
    "scope":"openid profile common"
}
```

سپس آدرس زیر را برای دسترسی به swagger سرویس common api را در مرورگر خود باز نمایید :

```
https://admin.local.dev/api/swagger/index.html
```
و از توکن دریافتی برای احراز هویت استفاده نمایید. حال کدام api ها را صدا بزنیم ؟ 
این دو api را که در تصویرهای زیر آمده صدا بزنید :

<p align="center">
  <img src="/assets/images/branch-wallet.png" />
</p>

شناسه شعبه کسب و کار تستی پرسا `2` می باشد

<p align="center">
  <img src="/assets/images/users-wallets.png" />
</p>

در اینجا مقدار شناسه اهمیتی ندارد و آن را با `0` پر نمایید.

### 🔹 15. راه اندازی Parsa

برای راه اندازی اپلیکیشن‌های پرسا از دستور زیر استفاده نمایید :
```sh
docker-compose -f .\docker-compose.parsa.yml up -d
```

### 🔹 16. راه اندازی Restora

راه اندازی restora نیز به مانند راه اندازی parsa می باشد و کافیست داکر کامپوز مربوط به آن را اجرا نمایید.

## 🔸 راه اندازی برای دفعات بعد
راه اندازی برای دفعات بعد نیاز به مراحل مشابه راه اندازی اول ندارد. کافیست تنها دستورات اجرای داکر کامپوزهای دلخواه خود را به ترتیب اجرا نمایید. نکته مهم در این قسمت این است که حتماً در ابتدا Infrastructure را اجرا کنید تا زیرساخت تمامی نرم افزارها برقرار باشد و بعد از اجرای داکر کامپوز بایستی یک الی دو دقیقه صبر نمایید. زیرا که اپلیکیشن های common و parsa و restora در startup خود به این سرویس ها سعی می کنند وصل شوند و اگر ارتباط برقرار نشود به خطا خواهند خورد و نیاز به down کردن داکر کامپوز و up کردن مجدد آن خواهید داشت. نکته مهم دیگر این است که قبل از اجرای داکر کامپوز parsa حتماً gateway را اجرا کنید. زیرا در شروع نرم افزار بک اند پرسا همسان سازی شعبه ها نیز انجام میشود و آدرس مورد نظر پرسا بر روی gateway تعریف شده است و راه ارتباطی آن به واسطه gateway برقرار می شود.

## 🔸 دسترسی به دیتای دیتابیس‌ها

چنانچه نیاز به دسترسی به دیتای داخل دیتابیس‌های mssql داشتید توصیه میشود از نرم افزار `Azure Data Studio` استفاده نمایید. این نرم افزار بسیار سبک است و برای تمامی سیستم عامل ها موجود می باشد. البته اگر توسعه دهندگانی بر روی سیستم خود `Mssql Management Studio` دارند نیاز به نصب اپلیکیشن دیگری ندارند و امکانات کاملتری را در اختیار دارند.

## 🔸 توسعه در آینده ؟

سورس کد پروژه docker-deploy متعلق به تمامی تیم‌های فعال در نوآوران آبی می باشد. بنابراین مسئولیت توسعه و نگهداری و همچنین بروزرسانی داکیومنت آن در صورت نیاز بر عهده تمامی تیم‌ها می باشد.
چنانچه در هر کدام از پروژه هایی که به واسه داکر کامپوزها اجرا می‌شوند تغییراتی ایجاد شود که برای استقرار آن در هر محیطی نیاز به تغییر در پروژه docker-deploy باشد بایستی این تغییرات نیز به صورت پول ریکوئست به این ریپازیتوری زده شود. و بهتر و مطمئن تر این است که در DOD تیم‌ها سازگاری تغییرات اعمال شده با پروژه docker-deploy نیز گنجانده شود. همچنین اگر در راستای این تغییرات نیاز به توضیحات یا اضافه شدن مراحلی برای deploy کردن پروژه ها بود این توضیحات بر روی repository پروژه docs نیز بایستی به صورت pull request بروز شوند. خواهشمند است با توجه به این موضوع در بروز نگه داشتن داکیومنتیشن و کد استقرار نرم‌افزارها کوشا باشید. 
با تشکر 🌺

