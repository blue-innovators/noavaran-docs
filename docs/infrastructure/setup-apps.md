# نصب نرم افزارهای شرکت روی سرور داکر
جهت نصب نرم افزارهای شرکت روی سرور لینوکسی که داکر روی آن نصب شده است به شکل زیر عمل میکنیم:

## دریافت دستورات اجرای نرم افزارها از git
ابتدا مطمئن باشید که در دایرکتوری مناسبی جهت clone کردن پروژه git قرار دارید.
سپس میتوانید از آدرس درنظر گرفته شده در گیت شرکت پروژه deploy-docker را clone نمایید:

```sh
git clone https://tfs.bidev.ir/DefaultCollection/Deployment/_git/deploy-docker
cd deploy-docker
```

## نکته جهت دسترسی کاربران دیگر به پروژه deploy
درصورتی که کاربران دیگری هم به سرور جهت کار با پروژه `deploy-docker` وارد میشوند، میتوانیم بعد از `clone` کردن پروژه، آنرا در یک مسیر دیگر که همه کاربران دسترسی داشته باشند قرار دهیم. بعنوان مثال `/app`:
```sh
sudo mv /deploy-docker /app
```

## انجام تنظیمات
جهت اجرای نرم افزارها ابتدا باید تغییراتی در تنظیمات ایجاد نمایید.

### انتخاب فایل docker-compose اصلی
ابتدا میتوانید فایل docker-compose اصلی که در این سرور از آن بیشتر استفاده میگردد را مشخص کنید که براحتی دستورات را اجرا نمایید.
بعنوان مثال اگر در سروری قرار دارید که قرار است پروژه های Common اجرا شوند به شکل زیر عمل میکنیم:
```sh
ln -s ./docker-compose.common.yml ./docker-compose.yml
```
از این طریق میتوانید پروژه های Common را تنها با اجرای دستور `docker-compose up` اجرا نمایید.

### ایجاد تنظیمات در فایل .env
برای اجرای دستورات docker-compose ابتدا نیاز داریم که فایل .env که شامل تنظیماتی است که به نرم افزارها ارسال میشود را ایجاد و تنظیم نماییم.
برای این کار کافی است از فایل نمونه `.env.sample` یک نمونه جدید ایجاد نماییم:
```sh
cp .env.sample .env
```
سپس فایل `.env` جدید را ویرایش میکنیم تا به تنظیمات صحیح برسیم.

## تنظیمات شبکه داخلی داکر برای نرم افزار
در فایلهای `docker-compose` همه سرویسها انتظار دارند به یک شبکه که از قبل تعریف شده به نام `appnet` متصل شوند و ip های خود را از آن دریافت کنند. این شبکه باید یک بار و قبل از اولین اجرای نرم افزارها ایجاد شود:
```sh
docker network create --driver=bridge --subnet=192.168.254.0/26 --gateway=192.168.254.1 appnet
```
این عمل برای جلوگیری از ایجاد شبکه ای با رنج هایی که در محیطهای شرکت استفاده میشود توسط داکر کامپوز که باعث ایجاد اختلال در اتصال به سرور نرم افزارها خواهد شد، انجام میشود. رنج توافق شده تا این لحظه `172.18.0.0/24` هست که به معنی این است که IP های `172.18.0.2 - 172.18.0.254` به کانتینر های هر سرور تعلق خواهد گرفت. و IP `172.18.0.1` هم gateway خواهد بود که توسط خود داکر مدیریت میشود.

## اجرای نرم افزارها
بر اساس اینکه سرور جاری به چه منظوری قرار است که استفاده شود قبلا یکی از فایلهای docker-compose را انتخاب کرده ایم.
حال کافی است که مجموعه نرم افزارهای مورد نظر را با دستور زیر اجرا نماییم:
```sh
docker-compose pull
docker-compose up -d
```
بعد از اجرای نرم افزار میتوانیم برای متوجه شدن از اتفاقات داخل نرم افزارها یا دیباگ آنها از دستورات زیر کمک بگیریم:
```sh
docker-compose ps -a # برای اینکه ببینیم نرم افزارها در حالت اجرا هستند یا بسته شده اند
docker-compose logs -f # برای اینکه لاگ نرم افزارها را مشاهده نماییم
```

## کارهایی که روی سرور بطور معمول انجام میشود
آپدیت نرم افزارها:
```sh
docker-compose down
docker-compose pull
docker-compose up -d
```
در صورتی که پروژه `deploy-docker` تغییراتی داشته و نیاز هست که در سرور اعمال شود، این تغییرات را با استفاده از دستور `git pull` بروز رسانی میکنیم.  

موقع اجرای این دستور از شما نام کاربری و کلمه عبور TFS را میخواهد که بعد از وارد کردن آنها آخرین تغییرات دریافت میشود.  
درصورتی که در فایلهای پروژه `deploy-docker` تغییراتی داده باشیم و دستور `git pull` با خطا مواجه شد،
ابتدا با استفاده از دستور `git diff` بررسی میکنیم که چه تغییراتی صورت گرفته. اگر تغییرات موقتی نبوده و لازم است که در نسخه اصلی هم قرار بگیرد، میتوانیم این تغییرات را کامیت کرده و push کنیم. اما درصورتی که تغییرات موقتی بوده و نیازی به آنها نداریم یا قبلا در نسخه اصلی پروژه قرار گرفته باشند، میتوانیم این تغییرات را با استفاده از دستور `git checkout -- .` undo کنیم.
سپس میتوانیم آخرین تغییرات را دریافت کنیم.  

درصورتی که مقادیر جدیدی به Environmrnt Variable ها اضافه شده باشد، با ویرایش فایل `.env` این تغییرات را اضافه میکنیم.
توجه داشته باشیم که برای اعمال شدن تغییرات env باید حتما سرویسها down و سپس up شوند.
