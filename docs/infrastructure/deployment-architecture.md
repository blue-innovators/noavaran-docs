# معماری سیستم

## نمای کلی سیستم
![Architecture Overview](/assets/images/production-architecture.png)

## شبکه توزیع محتوا (CDN)
زمانی که کاربر از طریق دستگاههای خود که به اینترنت متصل است درخواستی به سمت سرویس های ما ارسال میکند،
این درخواست ابتدا به CDN ارسال میشود، سپس به سمت سرورهای ما فوروارد میگردد. CDN دارای چندین ویژگی است که ما از ویژگی های زیر استفاده میکنیم:

1- سرویس DNS Server: از آنجایی که NS های دامنه های ما روی DNS سرورهای آروان تنظیم شده اند، تنظیمات DNS های ما در پنل آروان قابل تنظیم میباشند.

2- مجموعه سرویسهای WAF: سرویسهای CDN ها در پلن های رایگان نیز تا حد زیادی امکان WAF را برای ما فراهم مینمایند. از جمله مقاومت در برابر حملات DDOS و همچنین امکان مخفی کردن IP واقعی سرورها برای جلوگیری از لو رفتن و دسترسی مستقیم به آنها.

3- گواهی SSL: سرویسهای CDN ها در پلن های رایگان نیز امکان استفاده از SSL بصورت رایگان روی تمامی سرویسهای ارائه شده در زیرمجموعه دامنه های ما فراهم مینمایند. گواهی SSL ارائه شده بصورت رایگان توسظ `Let's Encrypt` ارائه میشود و بصورت خودکار نیز تمدید میگردد.

ابتدا، کاربر نهایی توسط یک مرورگر اینترنت در یکی از دستگاه (Device) های خود اقدام به درخواست به یکی از سرویسهای نرم افزار مینماید. این درخواست بصورت یک درخواست `https` به CDN ارسال شده و پس از اینکه درخواست توسط CDN بی خطر شناخته شد، این درخواست را به IP واقعی سرور `gateway` و بصورت یک درخواست `http` فوروارد میکند. سپس بر اساس `rule` های تعریف شده در `gateway` این درخواست به کانتینری در سرور های داخلی که وظیفه پردازش آن درخواست را دارد، میرسد و پس از تحلیل و انجام پردازش مورد نظر، جواب آن درخواست از همان مسیر به درخواست کننده برمیگردد.

## سرور درگاه سیستم (Gateway Server)
سرور Gateway در محدوده (Zone) ای از شبکه داخلی شرکت واقع شده که از طرفی، از طریق یک آدرس IP اینترنتی از بیرون از شرکت قابل دسترس است، و از طرفی به Zone های Private در شبکه داخلی شرکت متصل است. این محدوده که به DMZ (DeMilitary Zone) شناخته میشود، از طریق فایروال اجازه داده شده که فقط به پورت های 80 و 443 جواب دهد.  
در این سرور یک سرویس Nginx قرار گرفته که توسط rule هایی که برای آن تعریف شده، درخواست های ورودی را به سرویسهایی که در سرورهای محدوده داخلی شبکه قرار دارند فوروارد میکند.  

**توجه:** طبق توافقات صورت گرفته بین تیم های فنی شرکت، باید تمام سرویسهایی که در سرورهای داخلی شرکت قرار گرفته اند برای اینکه توسط nginx قابل دسترسی باشند باید به واحد IT شرکت اطلاع داده شود که ارتباط بین سرور Gateway و پورت اختصاص داده شده به سرویس در سرور مورد نظر برقرار شود.

## سرورهای نرم افزاری
نرم افزارهای شرکت بر اساس تیم های توسعه دهنده آنها روی سرورهای مختلفی جهت ارائه سرویس راه اندازی شده اند. روی هر سرور موتور `docker` نصب شده که نرم افزارهایی که روی هر سرور باید اجرا شوند را بصورت `container` های داکر اجرا میکند. هر کانتینر یک یا چند پورت را روی سرور `expose` میکند که توسط `gateway` قابل دسترس باشد. این پورت ها طبق توافق صورت گرفته بین تیم های فنی شرکت باید به اطلاع تیم زیرساخت برسد که دسترسی آنها به سرور `gateway` مربوطه برقرار شود.  

در حال حاظر سرورهای نرم افزاری زیر در سیستم وجود دارند:

* سرور Common: این سرور حاوی مجموعه سرویسهایی است که توسط تیم Common توسعه داده میشود. این سرویسها شامل موارد زیر میباشد:
    1. سرویس احراز هویت (Authentication Service): این سرویس یک OAuth Provider میباشد که مدیریت احراز هویت تمامی کاربران سیستم شامل کاربران پشتیبانی، کاربران کسب و کار و مشتریان را بر عهده دارد.
    2. سرویس Common: این سرویس وظیفه مدیریت تمامی اطلاعات مشترک بین همیه نرم افزار های مجوعه را بر عهده دارد. مانند انواع کاربران، کسب و کار ها و شعبه های آنها و غیره.
    3. سرویس پرداخت (Payment): این سرویس وظیفه مدیریت تراکنش های مالی و همچنین درگاه بانکی جهت انجام انواع مختلف پرداخت ها را در سیستم بر عهده دارد.
    4. سرویس اعتبارات (Credits): این سرویس وظیفه مدیریت اعتبارات افراد در سازمانهای مشتری را بر عهده دارد.
    5. سرویس ارسال پیام (Notification): این سرویس وظیفه ارسال پیام بصورت SMS یا ایمیل را برای تمامی نرم افزارهای مجموعه بر عهده دارد.
    6. سرویس لاگ (Audit Log): این سرویس میتواند انواع لاگ های تغییرات اشیای مهم سیستم را انجام دهد.
* سرور Restora: این سرور حاوی تمامی سرویسهای مربوط به نرم افزار رستورا (رزرو آنلاین) میباشد که توسط تیم رستورا توسعه داده میشود و از سرویسهای زیر تشکیل میشود:
    1. سرویس بک اند رستورا
    2. نرم افزار مهمانپذیر (Host App)
    3. نرم افزار مارکت پلیس (Marketplace)
* سرور Parsa: این سرور حاوی تمامی سرویسهای ارائه شده توسط تیم پرسا میباشد که از سرویسهای زیر تشکیل شده است:
    1. سرویس بک اند پرسا
    2. نرم افزار منو آنلاین (Order)
    3. نرم افزار صندوق (Pos)

## سرورهای زیرساختی
برخی دیگر از سرویسها در لایه زیرساخت قرار گرفته اند که بصورت زیر میباشند:

* سرور بانک اطلاعاتی (Database): یک سرور با سیستم عامل ویندوز است که یک نسخه از SQL Server Database Engine روی آن قرار گرفته که تمامی دیتابیس های نرم افزارهای مجموعه را مدیریت میکند.
* سرور Messaging (RabbitMq): در این سرور یک کلاستر RabbitMq نصب شده که وظیفه مدیریت تمام پیامهایی که برای ارتباط درونی نرم افزارهای مجموعه با یکدیگر نیاز است را بر عهده دارد.
* سرور فایل (Static Server): این سرور، سرویسهایی را شامل میشود که عملیات فایلی زیادی را انجام میدهند:
    1. سرویس Object Storage (Minio): این سرویس وظیفه ذخیره سازی و ارائه فایل هایی که در سیستم نیاز به نگهداری دارند را بر عهده دارد و از پروتکل S3 پشتیبانی مینماید.
    3. سرویس نگهداری لاگ Seq: این سرویس وظیفه ذخیره و ارائه لاگ های فنی شامل رویداد ها و خطاها برای تمام نرم افزارهای سیستم را بر عهده دارد و توسط یک داشبورد میتواند به پشتیبان فنی سیستم اطلاعات لازم را ارائه دهد.
